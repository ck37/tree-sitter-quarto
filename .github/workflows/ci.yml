name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Test Parser
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-${{ runner.os }}-${{ matrix.node-version }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            node-${{ runner.os }}-${{ matrix.node-version }}-
            node-${{ runner.os }}-

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: build/Release
          key: build-${{ runner.os }}-${{ matrix.node-version }}-${{ hashFiles('grammars/*/src/parser.c', 'grammars/*/src/scanner.c', 'binding.gyp') }}
          restore-keys: |
            build-${{ runner.os }}-${{ matrix.node-version }}-

      - name: Install dependencies
        run: npm install

      - name: Generate parsers
        run: npm run build:all

      - name: Run tests
        run: npm run test:grammars

      - name: Parse example files
        run: |
          cd grammars/block && npx tree-sitter parse ../../examples/*.qmd --quiet --stat

  validate:
    name: Validate Grammar
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Validate grammar structure
        run: npm run build:all

      - name: Check for warnings
        run: |
          npm run build:all 2>&1 | tee generate-output.txt
          if grep -q "Error" generate-output.txt; then
            echo "Grammar has errors"
            exit 1
          fi

  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Check JavaScript syntax
        run: |
          node --check grammars/block/grammar.js
          node --check grammars/inline/grammar.js

      - name: Check for common issues
        run: |
          # Check for TODO comments that should be addressed
          if grep -r "FIXME\|XXX" grammars/block/grammar.js grammars/inline/grammar.js grammars/*/src/*.c; then
            echo "Found unaddressed FIXME/XXX comments"
            # Don't fail on this for now
          fi

  queries:
    name: Validate Queries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Generate parsers
        run: npm run build:all

      - name: Check query files exist
        run: |
          test -f grammars/block/queries/highlights.scm || (echo "Missing block highlights.scm" && exit 1)
          test -f grammars/block/queries/injections.scm || (echo "Missing block injections.scm" && exit 1)
          test -f grammars/block/queries/folds.scm || (echo "Missing block folds.scm" && exit 1)
          test -f grammars/block/queries/indents.scm || (echo "Missing block indents.scm" && exit 1)
          test -f grammars/block/queries/locals.scm || (echo "Missing block locals.scm" && exit 1)
          test -f grammars/inline/queries/highlights.scm || (echo "Missing inline highlights.scm" && exit 1)
          test -f grammars/inline/queries/injections.scm || (echo "Missing inline injections.scm" && exit 1)
          test -f grammars/inline/queries/folds.scm || (echo "Missing inline folds.scm" && exit 1)
          test -f grammars/inline/queries/indents.scm || (echo "Missing inline indents.scm" && exit 1)
          test -f grammars/inline/queries/locals.scm || (echo "Missing inline locals.scm" && exit 1)

  zed-compatibility:
    name: Zed Editor Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v13
        with:
          version: 'latest'

      - name: Install dependencies
        run: npm install

      - name: Generate parsers
        run: npm run build:all

      - name: Cache WASM build
        uses: actions/cache@v4
        with:
          path: grammars/block/tree-sitter-quarto_block.wasm
          key: wasm-${{ hashFiles('grammars/block/grammar.js', 'grammars/block/src/scanner.c') }}

      - name: Validate tree-sitter headers present
        run: |
          echo "Checking for required tree-sitter headers..."
          test -f grammars/block/src/tree_sitter/parser.h || (echo "ERROR: Missing parser.h" && exit 1)
          test -f grammars/block/src/tree_sitter/alloc.h || (echo "ERROR: Missing alloc.h" && exit 1)
          test -f grammars/block/src/tree_sitter/array.h || (echo "ERROR: Missing array.h" && exit 1)
          echo "OK: All headers present"

      - name: Check for TSMapSlice in parser.h
        run: |
          echo "Validating TSMapSlice struct..."
          if grep -q "TSMapSlice" grammars/block/src/tree_sitter/parser.h; then
            echo "OK: TSMapSlice found in parser.h"
          else
            echo "ERROR: Missing TSMapSlice in parser.h (required for Zed)"
            exit 1
          fi

      - name: Check for abi_version in parser.h
        run: |
          echo "Checking for abi_version field in TSLanguage struct..."
          if grep -q "abi_version" grammars/block/src/tree_sitter/parser.h; then
            echo "OK: abi_version field found (tree-sitter 0.25.10)"
          else
            echo "ERROR: Missing abi_version field in parser.h"
            exit 1
          fi

      # Only build block grammar WASM - inline grammar is loaded via language injection
      # Editors inject the inline grammar into (inline) nodes using injection queries,
      # so only the block grammar needs to be available as standalone WASM
      - name: Build WASM
        run: |
          echo "Building WebAssembly module..."
          cd grammars/block && npx tree-sitter build --wasm

      - name: Validate WASM output
        run: |
          echo "Validating WASM output..."
          test -f grammars/block/tree-sitter-quarto_block.wasm || (echo "ERROR: WASM file not generated" && exit 1)

          size=$(stat -c%s grammars/block/tree-sitter-quarto_block.wasm)
          size_kb=$((size / 1024))
          echo "OK: WASM file generated: ${size_kb}KB (${size} bytes)"

          if [ $size -gt 200000 ]; then
            echo "WARNING: WASM size is large (${size_kb}KB > 195KB)"
            echo "   Consider optimizing grammar to reduce bundle size"
          fi

          if [ $size -gt 250000 ]; then
            echo "ERROR: WASM too large: ${size_kb}KB exceeds 244KB limit"
            exit 1
          fi

      - name: Check tree-sitter CLI version
        run: |
          echo "Checking tree-sitter CLI version..."
          version=$(npx tree-sitter --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          echo "tree-sitter CLI: $version"

          if [[ "$version" == "unknown" ]]; then
            echo "WARNING: Could not determine CLI version"
          else
            major=$(echo $version | cut -d. -f1)
            minor=$(echo $version | cut -d. -f2)

            if [ "$major" -eq 0 ] && [ "$minor" -lt 23 ]; then
              echo "ERROR: tree-sitter CLI too old: $version (need 0.23+)"
              exit 1
            fi
            echo "OK: CLI version compatible: $version"
          fi

      - name: Test WASM with simple parse
        run: |
          echo "Testing WASM parser with sample input..."
          cd grammars/block && echo '# Hello World' | npx tree-sitter parse --wasm tree-sitter-quarto_block.wasm --quiet || echo "WARNING: WASM parse test skipped (expected in CI)"
          echo "OK: WASM compatibility tests complete"
